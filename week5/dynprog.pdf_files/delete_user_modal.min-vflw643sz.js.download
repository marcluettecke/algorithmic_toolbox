define(["require","exports","tslib","react","spectrum/button","spectrum/icon_action","spectrum/icon_adminsymbol","spectrum/modal","modules/clean/ajax","modules/clean/components/modals/show_modal","modules/clean/contacts/contact_token_state","modules/clean/contacts/tokenizer","modules/clean/web_user_action_logger","modules/clean/web_user_action_events","modules/clean/react/css","modules/clean/react/teams/avatar/components","modules/clean/static_urls","modules/clean/teams/components/warning_box","modules/clean/teams/modals/member_info_modal_header","modules/clean/viewer","modules/core/exception","modules/core/i18n","modules/core/notify","modules/clean/ux_analytics_utils","modules/clean/ux_analytics_modal_tracking","modules/clean/contacts/types","spectrum/tooltip","spectrum/tertiary_link"],(function(e,t,a,n,s,o,r,i,l,c,m,d,u,p,f,_,h,E,v,y,g,b,M,A,N,k,R,O){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),n=a.__importDefault(n),l=a.__importStar(l),_=a.__importStar(_),k=a.__importDefault(k);var D,S,T=_.TeamUserAvatar;function I(e,t){u.WebUserActionLog.log(e,t,{source:"delete-user-modal"})}(function(e){e[e.LEGAL_HOLDS_FOR_TEAM_ADMINS=0]="LEGAL_HOLDS_FOR_TEAM_ADMINS",e[e.NEED_TEAM_ADMIN_PERMISSIONS=1]="NEED_TEAM_ADMIN_PERMISSIONS"})(D=t.ErrorMsgType||(t.ErrorMsgType={})),(function(e){e[e.MAIN=0]="MAIN",e[e.DELETE=1]="DELETE",e[e.OFFBOARD=2]="OFFBOARD",e[e.ERROR_MSG=3]="ERROR_MSG"})(S=t.ModalStep||(t.ModalStep={}));var C=(function(e){function t(t){var o,r=e.call(this,t)||this;r.onSubmit=function(){r.setState({submitting:!0});var e=r.props,t=e.userId,n=e.accountId,s=e.invited,o=e.email,i=e.isUserSuspended,c=e.teamJoinDate,m=e.storageUsed,d=e.accountPhotoUrl,u=e.recoverUserCallback,p=e.successCallback,f=e.teamAuthParams,_={user_id:t,account_id:n,should_disable:r.state.step===S.DELETE};r.state.step===S.DELETE&&(_=a.__assign(a.__assign({},_),{transfer_files:r.state.transferFiles,emails:"on"===r.state.transferFiles&&r.state.transferFilesToken?r.state.transferFilesToken.email:void 0,delete_on_unlink:r.state.deleteOnUnlink})),l.WebRequest({url:"/account/team/remove_user",data:_,subject_user:r.state.user,teamAuthParams:f,complete:function(){return r.setState({submitting:!1})},skipNotifyError:!0,success:function(e){var a,l,f=null,_=b._("Restore",{comment:"Undo message that enables restoring a recently deleted member"}),h=null;r.state.step===S.DELETE?(a="deleted",l=b.intl.formatMessage(b._("Deleted %(name)s’s account completely."),{name:r.displayName})):(a="converted",l=b.intl.formatMessage(b._("Converted %(name)s’s account to individual Dropbox Basic"),{name:r.displayName})),"on"===r.state.transferFiles||s||r.state.step!==S.DELETE||(f={user_id:t,account_id:n,user_name:r.displayName,email:o,is_user_suspended:i,team_join_date:c,storage_used:m,account_photo_url:d},h=u),r.close(),p(a,l,f,h,_)},error:function(e,t,a){"This user is currently under a legal hold."===a?r.setState({step:S.ERROR_MSG,errorMsg:D.LEGAL_HOLDS_FOR_TEAM_ADMINS}):"Only a team admin, can convert this account to a Basic account."===a?r.setState({step:S.ERROR_MSG,errorMsg:D.NEED_TEAM_ADMIN_PERMISSIONS}):a?M.Notify.error(a):(M.Notify.error(b._("There was a problem completing this request")),g.reportException({err:new Error(a),severity:"critical",tags:["delete_user_modal"]}),r.close())}})},r.onPrimaryAction=function(){var e=r.state,t=e.step,a=e.transferFiles,n=e.transferFilesToken;if(t===S.MAIN){if("on"===a&&(!n||r.contactsValidator(n).state!==m.ContactTokenState.ok))return void M.Notify.error(b._("Please enter a valid name or email address"));r.setState({step:S.DELETE})}else t===S.ERROR_MSG?r.close():r.onSubmit()},r.onLink=function(){r.setState({step:S.OFFBOARD})},r.onConvertAccountLink=function(){I(r.state.user.id,p.WebUserActionLogEvent.CLICK_CONVERT_INDIVIDUAL_ACCOUNT),r.onLink()},r.onReviewSummaryLink=function(){I(r.state.user.id,p.WebUserActionLogEvent.CLICK_REVIEW_SUMMARY_DELETE_USER),r.onLink()},r.onLearnMoreConversionLink=function(){I(r.state.user.id,p.WebUserActionLogEvent.CLICK_LEARN_MORE_ACCOUNT_CONVERSION)},r.onCancel=function(){r.state.step===S.MAIN||r.props.offboardOnly?r.close():r.setState({step:S.MAIN})},r.onTransferFilesChange=function(e){r.setState({transferFiles:e.currentTarget.value})},r.onDeleteOnUnlinkChange=function(e){r.setState({deleteOnUnlink:e.currentTarget.value})},r.onUpdateContacts=function(e){r.setState({transferFilesToken:e&&e[0]})},r.PRIMARY_ACTION_LABELS=((o={})[S.MAIN]=b._("Continue"),o[S.DELETE]=b._("Delete account"),o[S.OFFBOARD]=b._("Convert account"),o[S.ERROR_MSG]=b._("OK"),o),r.primaryAction=function(e){return n.default.createElement("span",null,r.state.submitting&&n.default.createElement("span",{className:"dbmodal-loading",key:"loading"},n.default.createElement("img",{src:h.static_url("/static/images/icons/ajax-loading-small-vfl3Wt7C_.gif"),alt:b._("Loading")})),n.default.createElement(s.Button,{disabled:r.state.submitting,variant:"primary",onClick:e},r.PRIMARY_ACTION_LABELS[r.state.step]))},r.secondaryAction=function(e){return r.state.step!==S.ERROR_MSG?n.default.createElement(s.Button,{disabled:r.state.submitting,variant:"secondary",onClick:e},b._("Cancel")):n.default.createElement("noscript",null)},r.getLink=function(){if(r.state.step===S.OFFBOARD||r.state.step===S.ERROR_MSG)return n.default.createElement("noscript",null);var e=b._("Convert to individual Dropbox Basic account instead");if(r.props.invited||r.props.noOffboardDueToAAL){var t=r.props.invited?b._("Can’t convert account because they haven’t joined the team"):b._("Can’t convert account because they’ve never signed in",{comment:"This string appears in a tooltip, explaining why the account of the user cannot be converted to a personal account"});return n.default.createElement(R.Tooltip,{tooltipContent:t,positioning:"above"},n.default.createElement(O.TertiaryLink,{className:"disabled-offboard-link"},e))}return n.default.createElement(O.TertiaryLink,{onClick:r.onConvertAccountLink},e)},r.setModalBodyRef=function(e){r.modalBody=e},r.contactsFilter=function(e){var t=e.email,a=e.type;return t!==r.props.email&&a!==k.default.NEW_STYLE_GROUP},r.contactsValidator=function(e){var t={state:m.ContactTokenState.ok};return e.on_team||(t={state:m.ContactTokenState.invalid,msg:b._("This person isn’t on your team")}),t},r.close=function(){r.props.cancelCallback&&r.props.cancelCallback(),r.setState({open:!1}),A.dispatchModalClosed()},r.onReady=function(){A.dispatchModalOpened()};var i=t.userId,c=t.accountId,d=t.offboardOnly;if(!i&&!c)throw new Error("Must provide user or account id");return r.state={transferFiles:"on",deleteOnUnlink:r.showRemoteWipe?"on":void 0,submitting:!1,step:d?S.OFFBOARD:S.MAIN,open:!0,user:y.Viewer.get_viewer().get_user_by_id(window.ensemble.viewer.getActiveUser().userId)},I(r.state.user.id,p.WebUserActionLogEvent.OPEN_DELETE_USER_MODAL),r}return a.__extends(t,e),t.prototype.render=function(){var e;switch(this.state.step){case S.MAIN:case S.DELETE:e=b.intl.formatMessage(b._("Delete %(display_name)s’s account completely"),{display_name:this.displayName});break;case S.OFFBOARD:e=b.intl.formatMessage(b._("Convert %(display_name)s’s account to individual Dropbox Basic account"),{display_name:this.displayName});break;case S.ERROR_MSG:e=b._("Can’t convert to a Dropbox Basic account")}return n.default.createElement(i.UtilityModal,{className:"delete-user-modal",overlayClassName:"delete-user-modal-overlay",title:e,width:"699px",primaryAction:this.primaryAction,secondaryAction:this.secondaryAction,link:this.getLink,onPrimaryAction:this.onPrimaryAction,onSecondaryAction:this.onCancel,onReady:this.onReady,onRequestClose:this.close,overlayClickClose:!1,ariaLabel:b._("Delete member"),open:this.state.open,shouldRequestCloseOnActions:!1},n.default.createElement(N.UXAnalyticsModalTracking,{id:"delete-user-modal"}),n.default.createElement("div",{tabIndex:0,ref:this.setModalBodyRef},this.state.step===S.MAIN&&this.renderMainModal(),this.state.step===S.DELETE&&this.renderDeleteModal(),this.state.step===S.OFFBOARD&&this.renderOffboardModal(),this.state.step===S.ERROR_MSG&&this.renderOffboardErrorModal()))},t.prototype.componentDidUpdate=function(){this.modalBody&&this.state.step===S.OFFBOARD&&this.modalBody.focus()},t.prototype.renderMainModal=function(){return[this.renderMemberInfoHeader(),this.renderMergedPersonalAccountWarning(),this.renderDeleteInfoMsg(),n.default.createElement("div",{className:"delete-settings"},this.renderTransferFilesSetting(),this.renderRemoteWipeSetting()),n.default.createElement("span",{className:"step-label"},b._("Step 1 of 2"))]},t.prototype.renderDeleteModal=function(){var e=[{icon:n.default.createElement(o.IconAction,{name:"delete"}),text:b._("Account will be deleted")},{icon:n.default.createElement(o.IconAction,{name:"permissions"}),text:b._("Member will no longer have access to the account")}];"on"===this.state.transferFiles&&this.state.transferFilesToken&&e.push({icon:n.default.createElement(o.IconAction,{name:"move"}),text:b.intl.formatMessage(b._("Member’s content will immediately be transferred to %(email)s"),{email:this.state.transferFilesToken.email})}),"on"===this.state.deleteOnUnlink&&e.push({icon:n.default.createElement(o.IconAction,{name:"permanently-delete"}),text:b._("All synced content will be deleted from this member’s devices the next time they come online")}),this.props.numApiApps&&e.push({icon:n.default.createElement(o.IconAction,{name:"link",className:"link-icon"}),text:b.intl.formatMessage(b._("Member has %(num_api_apps)s API apps that will stop working for their users"),{num_api_apps:this.props.numApiApps})});var t=[{icon:n.default.createElement(r.IconAdminsymbol,{name:"additional-license"}),text:b.intl.formatMessage(b._("%(team_name)s will get back one license"),{team_name:this.props.teamName})},{icon:n.default.createElement(o.IconAction,{name:"new-folder"}),text:b.intl.formatMessage(b._("%(team_name)s will keep all content"),{team_name:this.props.teamName})}],a="";return"on"===this.state.transferFiles&&this.state.transferFilesToken&&"suspended"===this.state.transferFilesToken.join_state&&(a=b.intl.formatMessage(b._("You’ve chosen to transfer account files to a suspended member, %(name)s. This member won’t be able to access any files until their suspension is removed."),{name:this.state.transferFilesToken.name||this.state.transferFilesToken.email})),[this.renderSummaryModal(e,t,void 0,void 0,a),n.default.createElement("span",{className:"step-label"},b._("Step 2 of 2"))]},t.prototype.renderOffboardErrorModal=function(){return this.state.errorMsg===D.LEGAL_HOLDS_FOR_TEAM_ADMINS?n.default.createElement("div",null,b.intl.formatMessage(b._("%(display_name)s’s content is currently being held. To convert this member’s account to a Basic account, you’ll first need to remove them from the hold on the <a>legal holds</a> page."),{display_name:this.props.displayName,a:function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return n.default.createElement("a",{href:"/team/admin/settings/legal_holds"},e)}})):this.state.errorMsg===D.NEED_TEAM_ADMIN_PERMISSIONS?n.default.createElement("div",null,b.intl.formatMessage(b._("Only a team admin can convert %(display_name)s’s account to a Basic account."),{display_name:this.props.displayName})):(M.Notify.error(b._("There was a problem completing this request")),g.reportException({err:new Error("Unrecognized errorMsg type: "+this.state.errorMsg),severity:"critical",tags:["delete_user_modal"]}),this.close(),n.default.createElement("noscript",null))},t.prototype.renderOffboardModal=function(){var e=b._("Member won’t have access to team-owned folders, and any file transfers they created will be deleted"),t=[{icon:n.default.createElement(r.IconAdminsymbol,{name:"personal-account"}),text:b._("Account will be disconnected from the team and converted to an individual account")},{icon:n.default.createElement(o.IconAction,{name:"new-folder"}),text:b._("Member will keep unshared files and folders, and shared folders that they own")},{icon:n.default.createElement(o.IconAction,{name:"permissions"}),text:e}];this.props.numApiApps&&t.push({icon:n.default.createElement(o.IconAction,{name:"link",className:"link-icon"}),text:b.intl.formatMessage(b._("Member has %(num_api_apps)s API apps that will stop working for their users"),{num_api_apps:this.props.numApiApps})}),t.push({icon:n.default.createElement(o.IconAction,{name:"new-paper-doc"}),text:b._("Member will still have access to Paper docs they own that aren’t shared")});var a=[{icon:n.default.createElement(r.IconAdminsymbol,{name:"additional-license"}),text:b.intl.formatMessage(b._("%(team_name)s will get back one license"),{team_name:this.props.teamName})},{icon:n.default.createElement(r.IconAdminsymbol,{name:"company"}),text:b.intl.formatMessage(b._("%(team_name)s will still keep team-owned folders"),{team_name:this.props.teamName})},{icon:n.default.createElement(o.IconAction,{name:"new-paper-doc"}),text:b._("You will become the owner of all shared Paper docs owned by this member")}],s=b._("This option is permanent. Please review the list above carefully before converting, as members might retain company data. You won’t be able to restore the account or make any changes to it.");return this.renderSummaryModal(t,a,void 0,"/help/business/convert-to-individual",s)},t.prototype.renderMemberInfoHeader=function(){return n.default.createElement(v.MemberInfoModalHeader,{displayName:this.props.displayName,email:this.props.email,storageUsed:this.props.storageUsed,accountPhotoUrl:this.props.accountPhotoUrl,teamJoinDate:this.props.teamJoinDate})},t.prototype.renderMergedPersonalAccountWarning=function(){return!this.props.mergedPersonalAccount||this.props.invited?null:n.default.createElement("div",{className:"merged-personal-account-warning"},n.default.createElement(r.IconAdminsymbol,{name:"alert"}),n.default.createElement("div",null,b.intl.formatMessage(b._("<b>Note:</b> This member merged an individual account with the %(team_name)s Dropbox account on %(date)s. They might have personal files in the account from before the merge. You can convert them to an individual Dropbox Basic account instead."),{team_name:this.props.teamName,date:this.props.teamJoinDate,b:function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return n.default.createElement("b",null,e)}}),n.default.createElement(s.Button,{onClick:this.onReviewSummaryLink,variant:"styleless"},b._("Review summary before converting"))))},t.prototype.renderDeleteInfoMsg=function(){return this.props.deleteInfoMsg?n.default.createElement("div",{className:"delete-info-msg"},this.props.deleteInfoMsg):null},t.prototype.renderTransferFilesSetting=function(){return n.default.createElement("div",{className:"transfer_files_setting"},n.default.createElement("div",{className:"verbal_setting_explanation"},b._("Do you want to transfer this member’s file content to another team member?")),n.default.createElement("div",{className:"deactivate_or_remove_setting_option"},n.default.createElement("label",null,n.default.createElement("input",{name:"transfer_files",type:"radio",value:"on",checked:"on"===this.state.transferFiles,"aria-checked":"on"===this.state.transferFiles,"aria-label":"Yes",onChange:this.onTransferFilesChange}),b._("Transfer now")),this.renderTokenizer()),n.default.createElement("div",{className:"deactivate_or_remove_setting_option"},n.default.createElement("label",null,n.default.createElement("input",{name:"transfer_files",type:"radio",value:"off",checked:"off"===this.state.transferFiles,"aria-checked":"off"===this.state.transferFiles,"aria-label":"No",onChange:this.onTransferFilesChange}),b._("Transfer later"),this.renderEvhMessage())))},t.prototype.renderTokenizer=function(){var e=this.props.customContactsDataSourceFactory,t=this.state.transferFilesToken&&{tokens:[this.state.transferFilesToken]};return n.default.createElement(d.ContactsTokenizer,{onContentsChange:this.onUpdateContacts,placeholder:b._("Recipient’s name or email"),populatedInputData:t,user:this.state.user,customContactFilter:this.contactsFilter,customContactValidator:this.contactsValidator,disabled:"off"===this.state.transferFiles,customContactsDataSourceFactory:e})},t.prototype.renderEvhMessage=function(){return this.props.evhEndDate?n.default.createElement("div",{className:"evh-message"},b.intl.formatMessage(b._("You can transfer content until <b>%(date)s</b>"),{b:function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return n.default.createElement("span",{className:"evh-date"},e)},date:this.props.evhEndDate})):null},t.prototype.renderRemoteWipeSetting=function(){return this.showRemoteWipe?n.default.createElement("div",{className:"remote_wipe_setting"},n.default.createElement("div",{className:"verbal_setting_explanation"},b._("Do you want to delete content from this member’s devices the next time they come online?")),n.default.createElement("div",{className:"deactivate_or_remove_setting_option"},n.default.createElement("label",null,n.default.createElement("input",{name:"delete_on_unlink",type:"radio",value:"on",checked:"on"===this.state.deleteOnUnlink,"aria-checked":"on"===this.state.deleteOnUnlink,"aria-label":"Yes",onChange:this.onDeleteOnUnlinkChange}),b._("Yes"))),n.default.createElement("div",{className:"deactivate_or_remove_setting_option"},n.default.createElement("label",null,n.default.createElement("input",{name:"delete_on_unlink",type:"radio",value:"off",checked:"off"===this.state.deleteOnUnlink,"aria-checked":"off"===this.state.deleteOnUnlink,"aria-label":"No",onChange:this.onDeleteOnUnlinkChange}),b._("No")))):null},t.prototype.renderSummaryModal=function(e,t,a,s,o){return n.default.createElement("div",null,o&&n.default.createElement(E.WarningBox,{warningText:o}),a&&n.default.createElement("div",null,a),n.default.createElement("div",{className:"user-summary"},n.default.createElement("div",{className:"summary-header"},n.default.createElement(T,{name:this.props.displayName,email:this.props.email,photo_url:this.props.accountPhotoUrl})),n.default.createElement("div",{className:"summary-items"},e.map(this.renderSummaryItem))),n.default.createElement("div",{className:"team-summary"},n.default.createElement("div",{className:"summary-header"},n.default.createElement("img",{src:h.static_url("/static/images/teams/building-vflJW1t3P.png"),alt:b._("Team")}),n.default.createElement("span",{className:"team-name"},this.props.teamName)),n.default.createElement("div",{className:"summary-items"},t.map(this.renderSummaryItem))),s&&n.default.createElement("div",{className:"full-summary-link"},n.default.createElement("a",{href:s,onClick:this.onLearnMoreConversionLink,target:"_blank",rel:"noopener noreferrer"},b._("Learn more about account conversion")," ")),o&&n.default.createElement("div",{className:"summary-warning-spacing"}))},t.prototype.renderSummaryItem=function(e){return n.default.createElement("div",{key:e.text,className:"summary-item"},n.default.createElement("span",{className:"summary-icon"},e.icon),n.default.createElement("span",{className:"summary-text"},e.text))},Object.defineProperty(t.prototype,"displayName",{get:function(){return this.props.displayName||this.props.email},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"showRemoteWipe",{get:function(){return!this.props.invited&&!this.props.hideRemoteWipe&&!this.props.noOffboardDueToAAL},enumerable:!0,configurable:!0}),t})(n.default.Component);t.DeleteUserModal=f.requireCssWithComponent(C,["/static/css/react/contacts_tokenizer-vfl6f1mr3.css","/static/css/teams/admin_team_modals-vfl1__Dze.css"]),t.showDeleteUserModal=function(e){return c.showModal(n.default.createElement(t.DeleteUserModal,a.__assign({},e)))}}));
//# sourceMappingURL=delete_user_modal.min.js-vflN85mnF.map